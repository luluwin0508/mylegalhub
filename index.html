<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My LegalHub - 个人知识库 (v1.7 Pro)</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .font-handwriting { font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif; }
        .prose h1 { color: #1e293b; font-weight: 800; border-bottom: 2px solid #e2e8f0; margin-top: 1em; padding-bottom: 0.3em; }
        .prose h2 { color: #334155; font-weight: 700; border-left: 4px solid #4f46e5; padding-left: 12px; margin-top: 1.5em; }
        .prose a { color: #4f46e5; text-decoration: none; border-bottom: 1px dashed #4f46e5; }
        .prose a:hover { border-bottom-style: solid; }
        .toc-active { color: #4f46e5; font-weight: 600; border-left: 2px solid #4f46e5; padding-left: 8px; margin-left: -10px; background-color: #f5f3ff; }
        /* 隐藏滚动条但保留功能 (用于热力图) */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyCkRDNNdfCDiH5AYBSOnu6U4M3rWnGvW9E",
            authDomain: "my-legal-hub.firebaseapp.com",
            projectId: "my-legal-hub",
            storageBucket: "my-legal-hub.firebasestorage.app",
            messagingSenderId: "789750197180",
            appId: "1:789750197180:web:b316b0265a2cafd1ca19b9",
            measurementId: "G-TRRH7MS9Z8"
        };

        const RECOMMENDED_LINKS = [
            { title: "SFC Codes and Guidelines", url: "https://www.sfc.hk/en/Regulatory-functions/Intermediaries/Licensing/Codes-and-guidelines", source: "SFC官网", tags: "法规 指引" },
            { title: "HKEX Listing Rules (主板上市规则)", url: "https://en-rules.hkex.com.hk/", source: "HKEX", tags: "上市规则 IPO" },
            { title: "SFC Newsletters (合规通讯)", url: "https://www.sfc.hk/en/Published-resources/Newsletters", source: "SFC官网", tags: "监管动态" },
            { title: "HKEX Guidance Letters (指引信)", url: "https://www.hkex.com.hk/Listing/Rules-and-Guidance/Guide-to-Listing/Guidance-Letters?sc_lang=en", source: "HKEX", tags: "指引信 IPO" },
            { title: "Takeovers Panel Decisions (收购委员会裁决)", url: "https://www.sfc.hk/en/Regulatory-functions/Listings-and-takeovers/Takeovers-and-Mergers/Decisions-and-statements", source: "SFC官网", tags: "并购 案例" },
            { title: "Webb-site (David Webb)", url: "https://webb-site.com/", source: "工具", tags: "尽调 数据库" },
            { title: "HKLII (香港法律资讯中心)", url: "https://www.hklii.org/en/", source: "工具", tags: "判例 法例" },
            { title: "金杜 (KWM) - 香港法律视野", url: "https://www.kwm.com/hk/en/insights.html", source: "金杜", tags: "律所观点" },
            { title: "汉坤 (Han Kun) - 研究文章", url: "https://www.hankunlaw.com/en/portal/publication/index.html", source: "汉坤", tags: "律所观点" },
            { title: "竞天公诚 (Jingtian) - 观点", url: "http://www.jingtian.com/Content/2019/04-23/1517596043.html", source: "竞天公诚", tags: "律所观点" },
            { title: "中伦 (Zhong Lun) - 研究", url: "https://www.zhonglun.com/research", source: "中伦", tags: "律所观点" }
        ];

        const RECOMMENDED_OFFICIALS = [
            { title: "SFC 证券及期货事务监察委员会", url: "https://www.sfc.hk/", source: "SFC", tags: "监管" },
            { title: "HKEX 香港交易所", url: "https://www.hkex.com.hk/", source: "HKEX", tags: "交易所" },
            { title: "HKMA 香港金融管理局", url: "https://www.hkma.gov.hk/", source: "HKMA", tags: "银行" },
            { title: "IA 保险业监管局", url: "https://www.ia.org.hk/", source: "IA", tags: "保险" },
            { title: "MPFA 积金局", url: "https://www.mpfa.org.hk/", source: "MPFA", tags: "退休金" },
            { title: "FSTB 财经事务及库务局", url: "https://www.fstb.gov.hk/", source: "政府", tags: "政策" },
            { title: "Companies Registry 公司注册处", url: "https://www.cr.gov.hk/", source: "政府", tags: "查册" },
            { title: "HK Judiciary 司法机构", url: "https://www.judiciary.hk/", source: "司法", tags: "法院" },
            { title: "e-Legislation 电子版香港法例", url: "https://www.elegislation.gov.hk/", source: "政府", tags: "法例" },
            { title: "中国证监会 (CSRC)", url: "http://www.csrc.gov.cn/", source: "CSRC", tags: "内地" },
            { title: "中国人民银行 (PBOC)", url: "http://www.pbc.gov.cn/", source: "PBOC", tags: "内地" }
        ];

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp, updateDoc, writeBatch, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        const { useState, useEffect, useMemo, useRef } = React;

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) { console.error(e); }

        // --- Icons ---
        const IconBase = ({ children, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const BookOpen = (p) => <IconBase {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>;
        const LinkIcon = (p) => <IconBase {...p}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></IconBase>;
        const PenTool = (p) => <IconBase {...p}><path d="m12 19 7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="m2 2 7.586 7.586"/><circle cx="11" cy="11" r="2"/></IconBase>;
        const Layers = (p) => <IconBase {...p}><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></IconBase>;
        const Plus = (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Trash2 = (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const ExternalLink = (p) => <IconBase {...p}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></IconBase>;
        const Search = (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>;
        const Menu = (p) => <IconBase {...p}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></IconBase>;
        const X = (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const Smartphone = (p) => <IconBase {...p}><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></IconBase>;
        const Save = (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const FolderOpen = (p) => <IconBase {...p}><path d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.55 6a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2"/></IconBase>;
        const LogOut = (p) => <IconBase {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></IconBase>;
        const DownloadCloud = (p) => <IconBase {...p}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><polyline points="12 12 12 21"/><polyline points="8 17 12 21 16 17"/></IconBase>;
        const Globe = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></IconBase>;
        const Calendar = (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>;
        const BarChart = (p) => <IconBase {...p}><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></IconBase>;
        const Zap = (p) => <IconBase {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>;
        const Settings = (p) => <IconBase {...p}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></IconBase>;
        const Edit2 = (p) => <IconBase {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconBase>;

        // --- Login Screen ---
        const LoginScreen = () => {
            const handleLogin = async () => {
                if (!auth) { alert("Firebase 初始化失败"); return; }
                try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (error) { console.error(error); alert("登录失败: " + error.message); }
            };
            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center">
                        <div className="mb-6 flex justify-center"><div className="bg-indigo-100 p-4 rounded-full"><BookOpen size={48} className="text-indigo-600" /></div></div>
                        <h1 className="text-2xl font-bold text-slate-900 mb-2">欢迎回来</h1>
                        <p className="text-slate-500 mb-8">请登录以访问您的个人知识库 (云端同步)</p>
                        <button onClick={handleLogin} className="w-full bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 font-medium py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-3 shadow-sm">使用 Google 账号登录</button>
                    </div>
                </div>
            );
        };

        const Sidebar = ({ activeTab, setActiveTab, isMobileMenuOpen, setIsMobileMenuOpen, user }) => {
            const menuItems = [
                { id: 'notes', label: '个人随手记', icon: <PenTool size={20} /> },
                { id: 'articles', label: '律所文章库', icon: <LinkIcon size={20} /> },
                { id: 'official', label: '监管官网', icon: <Globe size={20} /> },
                { id: 'socials', label: '社媒关注', icon: <Smartphone size={20} /> },
                { id: 'system', label: '体系知识', icon: <Layers size={20} /> },
            ];
            return (
                <>
                {isMobileMenuOpen && <div className="fixed inset-0 z-40 bg-black bg-opacity-50 md:hidden" onClick={() => setIsMobileMenuOpen(false)} />}
                <div className={`fixed inset-y-0 left-0 z-50 w-64 bg-slate-900 text-white transform transition-transform duration-300 ease-in-out md:relative md:translate-x-0 ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'} flex flex-col`}>
                    <div className="p-6 border-b border-slate-700"><h1 className="text-xl font-bold flex items-center gap-2"><BookOpen className="text-indigo-400" /><span>My LegalHub</span></h1></div>
                    <nav className="p-4 space-y-2 flex-1">{menuItems.map((item) => (<button key={item.id} onClick={() => { setActiveTab(item.id); setIsMobileMenuOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${activeTab === item.id ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-300 hover:bg-slate-800'}`}>{item.icon} <span className="font-medium">{item.label}</span></button>))}</nav>
                    <div className="p-4 border-t border-slate-800 bg-slate-800"><div className="text-xs text-slate-500 mb-2 text-center">v1.7 (Pro Heatmap)</div><div className="flex items-center gap-3 mb-4 px-2"><div className="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center text-xs font-bold">{user.email ? user.email[0].toUpperCase() : 'U'}</div><div className="flex-1 min-w-0"><p className="text-sm font-medium truncate">{user.displayName || '用户'}</p><p className="text-xs text-slate-500 truncate">{user.email}</p></div></div><button onClick={() => auth.signOut()} className="w-full flex items-center gap-2 px-2 py-2 text-slate-400 hover:text-white hover:bg-slate-700 rounded transition-colors text-sm"><LogOut size={16} /> 退出登录</button></div>
                </div>
                </>
            );
        };

        // --- Category Manager Modal ---
        const CategoryManager = ({ user, categories, onClose }) => {
            const [localCats, setLocalCats] = useState(categories);
            const [editingCat, setEditingCat] = useState(null);
            const [editName, setEditName] = useState("");

            useEffect(() => setLocalCats(categories), [categories]);

            const handleRename = async (oldName) => {
                const newName = prompt(`将分类 "${oldName}" 重命名为:`, oldName);
                if (!newName || newName === oldName) return;
                
                // Batch update all notes with oldName
                const q = query(collection(db, 'users', user.uid, 'notes'), where("category", "==", oldName));
                const snapshot = await getDocs(q);
                const batch = writeBatch(db);
                snapshot.docs.forEach(d => {
                    batch.update(doc(db, 'users', user.uid, 'notes', d.id), { category: newName });
                });
                await batch.commit();
                alert(`已将 ${snapshot.size} 条笔记的分类更新为 "${newName}"`);
                // Local state will update via listener in parent
            };

            const handleDelete = async (catName) => {
                if (!confirm(`确定删除分类 "${catName}" 吗？\n\n注意：该分类下的笔记不会被删除，而是会变为“未分类”。`)) return;
                
                const q = query(collection(db, 'users', user.uid, 'notes'), where("category", "==", catName));
                const snapshot = await getDocs(q);
                const batch = writeBatch(db);
                snapshot.docs.forEach(d => {
                    batch.update(doc(db, 'users', user.uid, 'notes', d.id), { category: "未分类" });
                });
                await batch.commit();
                alert("分类已删除");
            };

            const handleAdd = async () => {
                const name = prompt("输入新分类名称:");
                if(!name) return;
                // Since categories are derived from notes, we can add a dummy note or just let the user use it next time. 
                // Better: Just alert user they can use it. But to make it show up immediately, we might need a separate 'categories' collection. 
                // For simplicity in this app, we rely on existing notes. 
                // However, to support "Empty" categories, we'd need a collection. 
                // Compromise: Just guide user.
                alert(`提示：只需在写笔记时直接输入 "${name}"，该分类就会自动创建并保存。`);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-60 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 max-h-[80vh] flex flex-col">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold">分类管理</h3>
                            <button onClick={onClose}><X size={20} className="text-slate-400 hover:text-slate-600"/></button>
                        </div>
                        <div className="flex-1 overflow-y-auto space-y-2 pr-2">
                            {localCats.map(cat => (
                                <div key={cat} className="flex justify-between items-center p-3 bg-slate-50 rounded-lg group">
                                    <span className="font-medium text-slate-700">{cat}</span>
                                    <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onClick={() => handleRename(cat)} className="text-blue-500 hover:text-blue-700 p-1"><Edit2 size={16}/></button>
                                        <button onClick={() => handleDelete(cat)} className="text-red-400 hover:text-red-600 p-1"><Trash2 size={16}/></button>
                                    </div>
                                </div>
                            ))}
                            {localCats.length === 0 && <div className="text-center text-slate-400 py-4">暂无分类</div>}
                        </div>
                        <div className="mt-4 pt-4 border-t border-slate-100">
                            <button onClick={handleAdd} className="w-full py-2 bg-indigo-50 text-indigo-600 rounded-lg text-sm font-medium hover:bg-indigo-100 flex items-center justify-center gap-2">
                                <Plus size={16}/> 新建分类
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const NotesModule = ({ user }) => {
            const [notes, setNotes] = useState([]);
            const [newNote, setNewNote] = useState({ content: '', category: '金融法律知识' });
            const [search, setSearch] = useState('');
            const [stats, setStats] = useState({ total: 0, today: 0, streak: 0 });
            const [activityMap, setActivityMap] = useState({});
            const [availableCategories, setAvailableCategories] = useState([]);
            const [isAddingCategory, setIsAddingCategory] = useState(false);
            const [heatmapRange, setHeatmapRange] = useState('year'); // week, month, year, 3year
            const [showCatManager, setShowCatManager] = useState(false);

            const defaultCategories = ["金融法律知识", "金融知识", "数据法知识", "其他法律知识", "杂项"];

            useEffect(() => {
                if (!user || !db) return;
                const q = query(collection(db, 'users', user.uid, 'notes'), orderBy('createdAt', 'desc'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setNotes(docs);

                    const usedCategories = new Set(docs.map(n => n.category).filter(Boolean));
                    const merged = Array.from(new Set([...defaultCategories, ...usedCategories])).sort();
                    setAvailableCategories(merged);

                    const now = new Date();
                    const todayStr = now.toDateString();
                    let todayCount = 0;
                    const map = {};
                    
                    docs.forEach(n => {
                        if (n.createdAt) {
                            const d = new Date(n.createdAt.seconds * 1000);
                            map[d.toDateString()] = (map[d.toDateString()] || 0) + 1;
                            if (d.toDateString() === todayStr) todayCount++;
                        }
                    });

                    let streak = 0;
                    let checkDate = new Date();
                    if (!map[checkDate.toDateString()]) checkDate.setDate(checkDate.getDate() - 1);
                    while (map[checkDate.toDateString()] > 0) { streak++; checkDate.setDate(checkDate.getDate() - 1); }

                    setStats({ total: docs.length, today: todayCount, streak });
                    setActivityMap(map);
                });
                return () => unsubscribe();
            }, [user]);

            const handleAdd = async () => {
                if (!newNote.content.trim()) return;
                if (isAddingCategory && !newNote.category.trim()) { alert("请输入新分类名称"); return; }
                try {
                    await addDoc(collection(db, 'users', user.uid, 'notes'), {
                        content: newNote.content,
                        category: newNote.category,
                        createdAt: serverTimestamp()
                    });
                    setNewNote(prev => ({ ...prev, content: '' }));
                    setIsAddingCategory(false);
                } catch (e) { console.error(e); }
            };

            const handleDelete = async (id) => { if (confirm('删除这条笔记？')) await deleteDoc(doc(db, 'users', user.uid, 'notes', id)); };

            const filteredNotes = notes.filter(n => (n.content || '').toLowerCase().includes(search.toLowerCase()) || (n.category || '').toLowerCase().includes(search.toLowerCase()));

            // --- Heatmap Logic ---
            const renderHeatmap = () => {
                const now = new Date();
                let daysToRender = 365;
                let isGrid = true; // Use grid for Year/3Year, Flex for shorter

                if (heatmapRange === 'week') { daysToRender = 7; isGrid = false; }
                else if (heatmapRange === 'month') { daysToRender = 30; isGrid = false; }
                else if (heatmapRange === 'year') { daysToRender = 365; isGrid = true; }
                else if (heatmapRange === '3year') { daysToRender = 365 * 3; isGrid = true; }

                const days = [];
                for (let i = daysToRender - 1; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    days.push(d);
                }

                if (!isGrid) {
                    // Simple Flex Layout for short periods
                    return (
                        <div className="flex flex-wrap gap-1.5">
                            {days.map((day, idx) => {
                                const count = activityMap[day.toDateString()] || 0;
                                let color = "bg-slate-100";
                                if (count > 0) color = "bg-red-200";
                                if (count > 2) color = "bg-red-400";
                                if (count > 5) color = "bg-red-600";
                                return <div key={idx} title={`${day.toLocaleDateString()}: ${count}`} className={`w-4 h-4 rounded-sm ${color}`}></div>;
                            })}
                        </div>
                    );
                } else {
                    // GitHub Style Grid (Rows=7, Cols=dynamic)
                    // We need to group by weeks to render properly in a grid-flow-col setup with 7 rows
                    return (
                        <div className="overflow-x-auto no-scrollbar pb-2">
                            <div className="grid grid-rows-7 grid-flow-col gap-1 w-max">
                                {days.map((day, idx) => {
                                    const count = activityMap[day.toDateString()] || 0;
                                    let color = "bg-slate-100";
                                    if (count > 0) color = "bg-red-200";
                                    if (count > 2) color = "bg-red-400";
                                    if (count > 5) color = "bg-red-600";
                                    return <div key={idx} title={`${day.toLocaleDateString()}: ${count}`} className={`w-3 h-3 rounded-sm ${color}`}></div>;
                                })}
                            </div>
                        </div>
                    );
                }
            };

            return (
                <div className="h-full flex flex-col overflow-hidden bg-slate-50 p-6">
                    {/* Stats */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 flex-shrink-0">
                        <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between"><div><p className="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">累计笔记</p><p className="text-3xl font-bold text-slate-800">{stats.total} <span className="text-sm font-normal text-slate-400">条</span></p></div><div className="p-3 bg-indigo-50 text-indigo-500 rounded-lg"><BarChart size={24}/></div></div>
                        <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between"><div><p className="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">今日新增</p><p className="text-3xl font-bold text-slate-800">{stats.today} <span className="text-sm font-normal text-slate-400">条</span></p></div><div className="p-3 bg-pink-50 text-pink-500 rounded-lg"><PenTool size={24}/></div></div>
                        <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between"><div><p className="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">连续记录</p><p className="text-3xl font-bold text-slate-800">{stats.streak} <span className="text-sm font-normal text-slate-400">天</span></p></div><div className="p-3 bg-orange-50 text-orange-500 rounded-lg"><Zap size={24}/></div></div>
                    </div>

                    {/* Heatmap */}
                    <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100 mb-6 flex-shrink-0">
                        <div className="flex justify-between items-center mb-3">
                            <h3 className="text-sm font-bold text-slate-700 flex items-center gap-2"><Calendar size={16}/> 学习密度</h3>
                            <div className="flex bg-slate-100 rounded-lg p-1">
                                {['week', 'month', 'year', '3year'].map(r => (
                                    <button 
                                        key={r}
                                        onClick={() => setHeatmapRange(r)}
                                        className={`px-3 py-1 text-xs rounded-md transition-all ${heatmapRange === r ? 'bg-white shadow-sm text-indigo-600 font-bold' : 'text-slate-500 hover:text-slate-700'}`}
                                    >
                                        {r === 'week' ? '近1周' : r === 'month' ? '近1月' : r === 'year' ? '近1年' : '近3年'}
                                    </button>
                                ))}
                            </div>
                        </div>
                        {renderHeatmap()}
                    </div>

                    {/* Input & Feed */}
                    <div className="flex flex-col lg:flex-row gap-6 flex-1 min-h-0">
                        <div className="lg:w-1/3 flex flex-col">
                            <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100 h-full flex flex-col">
                                <h3 className="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2 text-red-500"><PenTool size={16}/> 记录此刻想法</h3>
                                <div className="space-y-3 flex-1 flex flex-col">
                                    <div className="flex gap-2 items-center">
                                        {isAddingCategory ? (
                                            <input className="flex-1 p-2.5 text-sm border border-slate-200 rounded-lg bg-slate-50 focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="输入新分类名称..." value={newNote.category} onChange={e => setNewNote({...newNote, category: e.target.value})} autoFocus />
                                        ) : (
                                            <div className="relative flex-1">
                                                <select className="w-full p-2.5 text-sm border border-slate-200 rounded-lg bg-slate-50 focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none font-medium text-slate-600" value={newNote.category} onChange={e => setNewNote({...newNote, category: e.target.value})}>
                                                    {availableCategories.map(c => <option key={c} value={c}>{c}</option>)}
                                                </select>
                                                <div className="absolute right-3 top-3 text-slate-400 pointer-events-none text-xs">▼</div>
                                            </div>
                                        )}
                                        {/* Toggle Add Mode */}
                                        <button onClick={() => { setIsAddingCategory(!isAddingCategory); if (!isAddingCategory) setNewNote(prev => ({ ...prev, category: '' })); else setNewNote(prev => ({ ...prev, category: availableCategories[0] || '杂项' })); }} className={`p-2.5 rounded-lg border transition-colors ${isAddingCategory ? 'bg-slate-200 text-slate-600 border-slate-300' : 'bg-white border-slate-200 text-slate-400 hover:text-red-500 hover:border-red-500'}`} title={isAddingCategory ? "取消" : "手动输入分类"}>
                                            {isAddingCategory ? <X size={16}/> : <Plus size={16}/>}
                                        </button>
                                        {/* Manage Categories Button */}
                                        <button onClick={() => setShowCatManager(true)} className="p-2.5 rounded-lg border bg-white border-slate-200 text-slate-400 hover:text-indigo-500 hover:border-indigo-500 transition-colors" title="管理分类 (重命名/删除)">
                                            <Settings size={16}/>
                                        </button>
                                    </div>
                                    <textarea className="w-full flex-1 p-3 text-sm border border-slate-200 rounded-lg bg-slate-50 focus:outline-none focus:ring-2 focus:ring-red-500 resize-none" placeholder="在此处输入笔记内容..." value={newNote.content} onChange={e => setNewNote({...newNote, content: e.target.value})}></textarea>
                                    <button onClick={handleAdd} className="w-full py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-bold transition-colors shadow-sm mt-auto">保存笔记</button>
                                </div>
                            </div>
                        </div>
                        <div className="lg:w-2/3 flex flex-col min-h-0">
                            <div className="mb-4 relative flex-shrink-0"><Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" size={18} /><input type="text" placeholder="搜索笔记..." className="w-full pl-10 pr-4 py-2.5 bg-white border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500 text-sm" value={search} onChange={(e) => setSearch(e.target.value)} /></div>
                            <div className="flex-1 overflow-y-auto space-y-4 pr-2">
                                {filteredNotes.length === 0 ? <div className="text-center py-20 text-slate-400 bg-white rounded-xl border border-slate-100"><p>暂无相关笔记</p></div> : filteredNotes.map(note => (
                                    <div key={note.id} className="bg-white p-5 rounded-xl border border-slate-100 hover:shadow-md transition-shadow group relative"><button onClick={() => handleDelete(note.id)} className="absolute top-4 right-4 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><Trash2 size={16} /></button><div className="flex items-center gap-2 mb-2"><span className="bg-slate-100 text-slate-600 text-xs font-bold px-2 py-1 rounded">{note.category}</span><span className="text-xs text-slate-400">{note.createdAt ? new Date(note.createdAt.seconds * 1000).toLocaleString() : ''}</span></div><div className="prose prose-sm max-w-none text-slate-700 whitespace-pre-wrap leading-relaxed">{note.content}</div></div>
                                ))}
                            </div>
                        </div>
                    </div>
                    
                    {/* Category Manager Modal */}
                    {showCatManager && <CategoryManager user={user} categories={availableCategories} onClose={() => setShowCatManager(false)} />}
                </div>
            );
        };

        const ArticlesModule = ({ user }) => {
            const [articles, setArticles] = useState([]);
            const [showModal, setShowModal] = useState(false);
            const [newArticle, setNewArticle] = useState({ title: '', url: '', source: '', tags: '' });
            const [searchTerm, setSearchTerm] = useState('');
            const [importing, setImporting] = useState(false);
            useEffect(() => { if (!user || !db) return; const q = query(collection(db, 'users', user.uid, 'articles'), orderBy('createdAt', 'desc')); const unsubscribe = onSnapshot(q, (snapshot) => { setArticles(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); }); return () => unsubscribe(); }, [user]);
            const handleAdd = async (e) => { e.preventDefault(); if (!newArticle.title || !newArticle.url) return; await addDoc(collection(db, 'users', user.uid, 'articles'), { ...newArticle, createdAt: serverTimestamp() }); setNewArticle({ title: '', url: '', source: '', tags: '' }); setShowModal(false); };
            const handleDelete = async (id) => { if (confirm('确定删除？')) await deleteDoc(doc(db, 'users', user.uid, 'articles', id)); };
            const handleImportRecommended = async () => { if (!confirm(`确定导入 ${RECOMMENDED_LINKS.length} 条推荐？`)) return; setImporting(true); try { const batch = writeBatch(db); RECOMMENDED_LINKS.forEach(link => { const docRef = doc(collection(db, 'users', user.uid, 'articles')); batch.set(docRef, { ...link, createdAt: serverTimestamp() }); }); await batch.commit(); alert("导入成功！"); } catch (e) { console.error(e); alert("导入失败"); } setImporting(false); };
            const filtered = articles.filter(item => (item.title || '').toLowerCase().includes(searchTerm.toLowerCase()) || (item.tags || '').toLowerCase().includes(searchTerm.toLowerCase()));
            return (
                <div className="h-full flex flex-col p-6 overflow-hidden">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4"><div><h2 className="text-2xl font-bold text-slate-800">律所文章库</h2><p className="text-slate-500 text-sm">SFC Compliance & Insights</p></div><div className="flex gap-2"><button onClick={handleImportRecommended} disabled={importing} className="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm text-sm"><DownloadCloud size={16} /> {importing ? '导入中...' : '一键导入'}</button><button onClick={() => setShowModal(true)} className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm text-sm"><Plus size={16} /> 新增文章</button></div></div>
                    <div className="mb-6 relative"><Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" size={18} /><input type="text" placeholder="搜索..." className="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /></div>
                    <div className="flex-1 overflow-y-auto pr-2 space-y-3">{filtered.map(article => (<div key={article.id} className="bg-white p-4 rounded-lg border border-slate-200 hover:shadow-md transition-shadow flex justify-between items-start group"><div className="flex-1"><div className="flex items-center gap-2 mb-1"><span className={`text-xs px-2 py-0.5 rounded font-medium ${article.source?.includes('SFC') ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-600'}`}>{article.source || '未分类'}</span><a href={article.url} target="_blank" className="font-semibold text-slate-800 hover:text-indigo-600 truncate flex items-center gap-1">{article.title} <ExternalLink size={14} className="opacity-50" /></a></div><div className="flex flex-wrap gap-2 mt-2">{article.tags.split(' ').map((t,i) => t && <span key={i} className="text-xs text-indigo-500 bg-indigo-50 px-2 py-1 rounded">#{t}</span>)}</div></div><button onClick={() => handleDelete(article.id)} className="text-slate-300 hover:text-red-500 p-2 opacity-0 group-hover:opacity-100"><Trash2 size={16} /></button></div>))}</div>
                    {showModal && <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"><div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6"><h3 className="text-xl font-bold mb-4">添加文章</h3><form onSubmit={handleAdd} className="space-y-4"><input required className="w-full p-2 border rounded" placeholder="标题" value={newArticle.title} onChange={e => setNewArticle({...newArticle, title: e.target.value})} /><input required type="url" className="w-full p-2 border rounded" placeholder="URL" value={newArticle.url} onChange={e => setNewArticle({...newArticle, url: e.target.value})} /><div className="grid grid-cols-2 gap-4"><input className="w-full p-2 border rounded" placeholder="来源" value={newArticle.source} onChange={e => setNewArticle({...newArticle, source: e.target.value})} /><input className="w-full p-2 border rounded" placeholder="标签" value={newArticle.tags} onChange={e => setNewArticle({...newArticle, tags: e.target.value})} /></div><div className="flex gap-3 mt-6"><button type="button" onClick={() => setShowModal(false)} className="flex-1 py-2 border rounded">取消</button><button type="submit" className="flex-1 py-2 bg-indigo-600 text-white rounded">保存</button></div></form></div></div>}
                </div>
            );
        };
        
        const OfficialModule = ({ user }) => {
            const [links, setLinks] = useState([]);
            const [showModal, setShowModal] = useState(false);
            const [newLink, setNewLink] = useState({ title: '', url: '', source: 'SFC', tags: '' });
            const [searchTerm, setSearchTerm] = useState('');
            const [importing, setImporting] = useState(false);
            useEffect(() => { if (!user || !db) return; const q = query(collection(db, 'users', user.uid, 'official_links'), orderBy('createdAt', 'desc')); const unsubscribe = onSnapshot(q, (snapshot) => { setLinks(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); }); return () => unsubscribe(); }, [user]);
            const handleAdd = async (e) => { e.preventDefault(); if (!newLink.title || !newLink.url) return; await addDoc(collection(db, 'users', user.uid, 'official_links'), { ...newLink, createdAt: serverTimestamp() }); setNewLink({ title: '', url: '', source: 'SFC', tags: '' }); setShowModal(false); };
            const handleDelete = async (id) => { if (confirm('确定删除？')) await deleteDoc(doc(db, 'users', user.uid, 'official_links', id)); };
            const handleImportRecommended = async () => { if (!confirm(`确定导入 ${RECOMMENDED_OFFICIALS.length} 个监管官网？`)) return; setImporting(true); try { const batch = writeBatch(db); RECOMMENDED_OFFICIALS.forEach(link => { const docRef = doc(collection(db, 'users', user.uid, 'official_links')); batch.set(docRef, { ...link, createdAt: serverTimestamp() }); }); await batch.commit(); alert("导入成功！"); } catch (e) { console.error(e); alert("导入失败"); } setImporting(false); };
            const filtered = links.filter(item => (item.title || '').toLowerCase().includes(searchTerm.toLowerCase()) || (item.tags || '').toLowerCase().includes(searchTerm.toLowerCase()));
            return (
                <div className="h-full flex flex-col p-6 overflow-hidden">
                    <div className="flex justify-between items-center mb-6"><div><h2 className="text-2xl font-bold text-slate-800">监管官网</h2><p className="text-slate-500 text-sm">Official Regulatory Websites</p></div><div className="flex gap-2"><button onClick={handleImportRecommended} disabled={importing} className="bg-sky-500 hover:bg-sky-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm text-sm"><DownloadCloud size={16} /> {importing ? '导入中...' : '一键导入'}</button><button onClick={() => setShowModal(true)} className="bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm text-sm"><Plus size={16} /> 新增网站</button></div></div>
                    <div className="mb-6 relative"><Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" size={18} /><input type="text" placeholder="搜索官网..." className="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /></div>
                    <div className="flex-1 overflow-y-auto pr-2 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{filtered.map(link => (<div key={link.id} className="bg-white p-4 rounded-xl border border-slate-200 hover:shadow-lg transition-all flex flex-col justify-between group h-32 relative"><button onClick={() => handleDelete(link.id)} className="absolute top-2 right-2 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><Trash2 size={14} /></button><div><div className="flex items-center gap-2 mb-2"><div className="p-1.5 bg-sky-50 rounded text-sky-600"><Globe size={16}/></div><span className="text-xs font-bold text-slate-500 uppercase tracking-wide">{link.source}</span></div><h3 className="font-bold text-slate-800 line-clamp-2">{link.title}</h3></div><a href={link.url} target="_blank" className="text-xs text-sky-600 font-medium hover:underline flex items-center gap-1 mt-2">访问网站 <ExternalLink size={10} /></a></div>))}</div>
                    {showModal && <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"><div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6"><h3 className="text-xl font-bold mb-4">添加官网</h3><form onSubmit={handleAdd} className="space-y-4"><input required className="w-full p-2 border rounded" placeholder="网站名称" value={newLink.title} onChange={e => setNewLink({...newLink, title: e.target.value})} /><input required type="url" className="w-full p-2 border rounded" placeholder="网址 URL" value={newLink.url} onChange={e => setNewLink({...newLink, url: e.target.value})} /><div className="grid grid-cols-2 gap-4"><input className="w-full p-2 border rounded" placeholder="机构" value={newLink.source} onChange={e => setNewLink({...newLink, source: e.target.value})} /><input className="w-full p-2 border rounded" placeholder="标签" value={newLink.tags} onChange={e => setNewLink({...newLink, tags: e.target.value})} /></div><div className="flex gap-3 mt-6"><button type="button" onClick={() => setShowModal(false)} className="flex-1 py-2 border rounded">取消</button><button type="submit" className="flex-1 py-2 bg-sky-600 text-white rounded">保存</button></div></form></div></div>}
                </div>
            );
        };

        const SocialsModule = ({ user }) => {
            const [socials, setSocials] = useState([]);
            const [showModal, setShowModal] = useState(false);
            const [newItem, setNewItem] = useState({ name: '', url: '', category: '刑法合规', platform: 'XHS' });
            const [activeCategory, setActiveCategory] = useState('全部');
            useEffect(() => { if (!user || !db) return; const q = query(collection(db, 'users', user.uid, 'socials'), orderBy('createdAt', 'desc')); const unsubscribe = onSnapshot(q, (snapshot) => { setSocials(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); }); return () => unsubscribe(); }, [user]);
            const handleAdd = async (e) => { e.preventDefault(); if (!newItem.name || !newItem.url) { alert("请填写完整"); return; } await addDoc(collection(db, 'users', user.uid, 'socials'), { ...newItem, createdAt: serverTimestamp() }); setActiveCategory('全部'); setNewItem({ name: '', url: '', category: '刑法合规', platform: 'XHS' }); setShowModal(false); };
            const handleDelete = async (id) => { if (confirm('删除？')) await deleteDoc(doc(db, 'users', user.uid, 'socials', id)); };
            const categories = ['全部', ...new Set(socials.map(i => i.category))];
            const filtered = activeCategory === '全部' ? socials : socials.filter(i => i.category === activeCategory);
            return (
                <div className="h-full flex flex-col p-6"><div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold text-slate-800">社媒关注管理</h2><button onClick={() => setShowModal(true)} className="bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm"><Plus size={18} /> 添加博主</button></div><div className="flex gap-2 mb-6 overflow-x-auto pb-2">{categories.map(cat => (<button key={cat} onClick={() => setActiveCategory(cat)} className={`px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${activeCategory === cat ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-600'}`}>{cat}</button>))}</div><div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 overflow-y-auto pr-2">{filtered.map(item => (<div key={item.id} className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-all relative group"><button onClick={() => handleDelete(item.id)} className="absolute top-2 right-2 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><Trash2 size={14} /></button><div className="flex items-center gap-3 mb-3"><div className={`w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm ${item.platform === 'XHS' ? 'bg-red-500' : 'bg-green-600'}`}>{item.platform === 'XHS' ? '书' : '微'}</div><div className="flex-1 overflow-hidden"><h3 className="font-bold text-slate-800 truncate">{item.name}</h3><span className="text-xs text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded">{item.category}</span></div></div><a href={item.url} target="_blank" className="block w-full text-center py-2 rounded-lg bg-slate-50 text-indigo-600 font-medium text-sm hover:bg-indigo-50">访问主页</a></div>))}</div>{showModal && <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"><div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6"><h3 className="text-xl font-bold mb-4">添加关注</h3><form onSubmit={handleAdd} className="space-y-4"><div className="grid grid-cols-2 gap-4"><select className="w-full p-2 border rounded" value={newItem.platform} onChange={e => setNewItem({...newItem, platform: e.target.value})}><option value="XHS">小红书</option><option value="WX">公众号</option></select><input className="w-full p-2 border rounded" placeholder="分类" value={newItem.category} onChange={e => setNewItem({...newItem, category: e.target.value})} /></div><input required className="w-full p-2 border rounded" placeholder="名称" value={newItem.name} onChange={e => setNewItem({...newItem, name: e.target.value})} /><input required type="url" className="w-full p-2 border rounded" placeholder="URL" value={newItem.url} onChange={e => setNewItem({...newItem, url: e.target.value})} /><div className="flex gap-3 mt-6"><button type="button" onClick={() => setShowModal(false)} className="flex-1 py-2 border rounded">取消</button><button type="submit" className="flex-1 py-2 bg-pink-500 text-white rounded">添加</button></div></form></div></div>}</div>
            );
        };

        const SystemKnowledgeModule = ({ user }) => {
            const [topics, setTopics] = useState([]);
            const [activeTopic, setActiveTopic] = useState(null);
            const [isEditing, setIsEditing] = useState(false);
            const [editContent, setEditContent] = useState('');
            const [newTopicName, setNewTopicName] = useState('');
            const [toc, setToc] = useState([]);
            useEffect(() => { if (!user || !db) return; const q = query(collection(db, 'users', user.uid, 'knowledge'), orderBy('createdAt', 'desc')); const unsubscribe = onSnapshot(q, (snapshot) => { setTopics(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); }); return () => unsubscribe(); }, [user]);
            const currentTopicData = useMemo(() => topics.find(t => t.id === activeTopic), [topics, activeTopic]);
            useEffect(() => { if (currentTopicData && !isEditing) { const headings = []; const safeContent = typeof currentTopicData.content === 'string' ? currentTopicData.content : ''; const lines = safeContent.split('\n'); lines.forEach((line) => { const match = line.match(/^(#{1,3})\s*(.+)$/); if (match) { const level = match[1].length; const text = match[2]; const id = 'heading-' + Math.random().toString(36).substr(2, 9); headings.push({ id, text, level }); } }); setToc(headings); } }, [currentTopicData, isEditing]);
            const getMarkdownHtml = (content) => { if (!content) return ''; if (typeof content !== 'string') return 'Error: Content is not text.'; if (content.includes('[object Object]')) { return '<div class="p-4 bg-red-50 text-red-600 rounded">检测到数据异常 (包含 [object Object])。请点击右上角“编辑”，手动删除该行文字。</div>' + marked.parse(content.replace(/\[object Object\]/g, '')); } let headingIndex = 0; const renderer = new marked.Renderer(); renderer.heading = (text, level) => { const id = toc[headingIndex] ? toc[headingIndex].id : ''; headingIndex++; return `<h${level} id="${id}">${text}</h${level}>`; }; return marked.parse(content, { renderer }); };
            const scrollToHeading = (id) => { const el = document.getElementById(id); if (el) el.scrollIntoView({ behavior: 'smooth' }); };
            const handleAddTopic = async () => { if (!newTopicName.trim()) return; const res = await addDoc(collection(db, 'users', user.uid, 'knowledge'), { title: newTopicName, content: '# ' + newTopicName + '\n\n开始撰写...', createdAt: serverTimestamp() }); setNewTopicName(''); setActiveTopic(res.id); };
            const handleSaveContent = async () => { if (!activeTopic) return; await updateDoc(doc(db, 'users', user.uid, 'knowledge', activeTopic), { content: editContent, updatedAt: serverTimestamp() }); setIsEditing(false); };
            const handleDeleteTopic = async (e, id) => { e.stopPropagation(); if(confirm('删除？')) { if (activeTopic === id) setActiveTopic(null); await deleteDoc(doc(db, 'users', user.uid, 'knowledge', id)); } };
            return (
                <div className="h-full flex flex-col md:flex-row bg-white">
                    <div className="w-full md:w-64 border-r border-slate-200 flex flex-col bg-slate-50">
                        <div className="p-4 border-b border-slate-200"><h2 className="font-bold text-slate-700 flex items-center gap-2"><FolderOpen size={18} /> 知识体系</h2></div>
                        <div className="flex-1 overflow-y-auto p-2 space-y-1">{topics.map(topic => (<div key={topic.id} onClick={() => { setActiveTopic(topic.id); setIsEditing(false); }} className={`group flex items-center justify-between px-3 py-2 rounded-lg cursor-pointer text-sm ${activeTopic === topic.id ? 'bg-white shadow-sm text-indigo-600 border border-slate-200' : 'text-slate-600 hover:bg-slate-100'}`}><span className="truncate flex-1">{topic.title}</span><button onClick={(e) => handleDeleteTopic(e, topic.id)} className="opacity-0 group-hover:opacity-100 p-1 hover:text-red-500"><Trash2 size={14} /></button></div>))}</div>
                        <div className="p-3 border-t border-slate-200 flex gap-2"><input className="flex-1 px-2 py-1 text-sm border rounded" placeholder="新主题..." value={newTopicName} onChange={e => setNewTopicName(e.target.value)} /><button onClick={handleAddTopic} className="bg-indigo-600 text-white p-1.5 rounded"><Plus size={16} /></button></div>
                    </div>
                    <div className="flex-1 flex flex-col h-full overflow-hidden relative">
                        {activeTopic && currentTopicData ? (<><div className="p-4 border-b border-slate-200 flex justify-between items-center bg-white"><span className="text-slate-500 text-xs">上次更新: {new Date().toLocaleDateString()}</span>{isEditing ? (<div className="flex gap-2"><button onClick={() => setIsEditing(false)} className="px-3 py-1.5 text-sm rounded hover:bg-slate-100">取消</button><button onClick={handleSaveContent} className="px-3 py-1.5 text-sm bg-indigo-600 text-white rounded">保存</button></div>) : (<button onClick={() => { setEditContent(currentTopicData.content); setIsEditing(true); }} className="px-3 py-1.5 text-sm border rounded hover:bg-slate-50 flex items-center gap-1"><PenTool size={14} /> 编辑</button>)}</div><div className="flex-1 overflow-y-auto p-8 bg-white flex flex-row"><div className="flex-1 pr-4 max-w-4xl">{isEditing ? <textarea className="w-full h-full resize-none outline-none font-mono text-sm leading-relaxed p-4 bg-slate-50 rounded" value={editContent} onChange={e => setEditContent(e.target.value)} /> : <div className="prose prose-slate max-w-none" dangerouslySetInnerHTML={{ __html: getMarkdownHtml(currentTopicData.content) }}></div>}</div>{!isEditing && toc.length > 0 && (<div className="w-48 pl-4 border-l border-slate-100 hidden lg:block overflow-y-auto max-h-screen sticky top-0"><div className="text-xs font-bold text-slate-400 mb-2 uppercase">目录 (TOC)</div><ul className="space-y-2">{toc.map((h, i) => (<li key={i} className={`text-xs cursor-pointer hover:text-indigo-600 transition-colors ${h.level === 1 ? 'font-bold' : 'pl-2 text-slate-500'}`} onClick={() => scrollToHeading(h.id)}>{h.text}</li>))}</ul></div>)}</div></>) : (<div className="flex-1 flex items-center justify-center text-slate-400 flex-col gap-4"><Layers size={48} className="opacity-20" /><p>请选择或创建一个知识主题</p></div>)}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('notes'); 
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            useEffect(() => { if (!auth) { setLoading(false); return; } const unsubscribe = onAuthStateChanged(auth, (u) => { setUser(u); setLoading(false); }); return () => unsubscribe(); }, []);
            if (loading) return <div className="flex h-screen items-center justify-center">加载中...</div>;
            if (!user) return <LoginScreen />;
            return (
                <div className="flex h-screen bg-slate-50 font-sans text-slate-900 overflow-hidden">
                    <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} isMobileMenuOpen={isMobileMenuOpen} setIsMobileMenuOpen={setIsMobileMenuOpen} user={user} />
                    <div className="flex-1 flex flex-col w-full h-full">
                        <div className="md:hidden p-4 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm z-10"><span className="font-bold text-slate-700">My LegalHub</span><button onClick={() => setIsMobileMenuOpen(true)}><Menu className="text-slate-600" /></button></div>
                        <main className="flex-1 overflow-hidden relative">
                            {activeTab === 'notes' && <NotesModule user={user} />}
                            {activeTab === 'articles' && <ArticlesModule user={user} />}
                            {activeTab === 'official' && <OfficialModule user={user} />}
                            {activeTab === 'socials' && <SocialsModule user={user} />}
                            {activeTab === 'system' && <SystemKnowledgeModule user={user} />}
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
